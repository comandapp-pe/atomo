<%= render 'admin/header' %>

<% @idea = @order.ideas.new unless @idea.present? %>
<% @phrase = @order.phrases.new unless @phrase.present? %>

<main class="container px-4">
  <% if notice %>
    <div id="notice" class="alert alert-success alert-dismissible fade show">
      <%= notice %>

      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <%= link_to '< Regresar', admin_orders_path, class: 'text-decoration-none' %>

  <h1>Orden #<%= @order.checkout_code %></h1>

  <p>A las <strong><%= @order.created_at.in_time_zone('America/Lima').strftime('%Y/%m/%d - %H:%M') %></strong></p>

  <div class="card">
    <h2 class="card-header h5">Cliente</h2>
    <div class="card-body">
      <p class="card-text"><strong>Nombres y Apellidos:</strong> <%= @order.customer_first_name %> <%= @order.customer_last_name %></p>
      <p class="card-text"><strong>Correo:</strong> <%= mail_to @order.customer_email %></p>
    </div>
  </div>

  <br>

  <div class="card">
    <h2 class="card-header h5">Producto</h2>
    <div class="card-body">
      <p class="card-text"><%= link_to @order.product.name, [:admin, @order.product], class: 'text-decoration-none' %></p>
      <div class="ratio ratio-16x9">
        <%= @order.product.preview_html.html_safe %>
      </div>
    </div>
  </div>

  <br>

  <div class="card">
    <h2 class="card-header h5">Formato</h2>
    <div class="card-body">
      <p class="card-text"><%= @order.format.titlecase %></p>
    </div>
  </div>

  <br>

  <div class="card">
    <h2 class="card-header h5">Metraje</h2>
    <div class="card-body">
      <p class="card-text"><%= @order.length %> segundos</p>
    </div>
  </div>

  <br>

  <div class="card">
    <h2 class="card-header h5">Pago</h2>
    <div class="card-body">
      <p class="card-text"><strong>Método:</strong> <%= @order.payment_method %></p>
      <p class="card-text"><strong>Comisión de 2Checkout:</strong> <%= number_to_currency @order.checkout_commission %></p>
      <p class="card-text"><strong>Total:</strong> <%= number_to_currency @order.total %></p>
    </div>
  </div>

  <br>

  <div class="card">
    <h2 class="card-header h5">Videos</h2>
    <div class="card-body border-bottom">
      <%= render partial: 'videos/form', locals: { order: @order } %>
    </div>

    <div class="card-body">
      <div id="all_videos" class="row g-2" data-controller="empty-state" >
        <div data-empty-state-target="emptyState">La orden no tiene videos disponibles.</div>

        <%= render partial: 'videos/video', collection: @order.videos.filter(&:persisted?) %>
      </div>
    </div>
  </div>

  <br>

  <div class="card">
    <div class="card-header h5">Fotos</div>

    <div class="card-body border-bottom">
      <%= render partial: 'photos/form', locals: { order: @order } %>
    </div>

    <div class="card-body">
      <div id="all_photos" class="row g-2" data-controller="empty-state">
        <div data-empty-state-target="emptyState">La orden no tiene fotos disponibles.</div>

        <%= render partial: 'photos/photo', collection: @order.photos.filter(&:persisted?) %>
      </div>
    </div>
  </div>

  <br>

  <div class="card">
    <div class="card-header h5">Fuentes (Tipos de letra)</div>
    <div class="card-body">
      <%= form_with url: order_fonts_path(@order.id), method: :post do |form| %>
        <% if @order.errors[:fonts].any? %>
          <div class="alert alert-danger" role="alert">
            <h2><%= pluralize(@order.errors.count, "error") %> evitaron guardar esta orden:</h2>
            <hr>
            <ul>
              <% @order.errors[:fonts].each do |error| %>
                <li><%= error %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-group">
          <%= form.file_field :fonts, class: 'form-control', required: true, accept: 'application/zip' %>
          <div class="form-text">Cada fuente debe estar en formato ZIP y pesar 10 MB como máximo.</div>
        </div>

        <div>
          <%= form.submit 'Añadir fuente', class: 'btn btn-primary mt-2' %>
        </div>
      <% end %>
    </div>

    <% if @order.fonts.filter(&:persisted?).empty? %>
      <div class="card-body border-top">La orden no tiene fuentes disponibles.</div>
    <% else %>
      <ul class="list-group list-group-flush">
        <% @order.fonts.filter(&:persisted?).each do |font| %>
          <li class="list-group-item">
            <div class="d-flex flex-column flex-md-row justify-content-md-between">
              <div class="overflow-hidden" style="white-space: nowrap; text-overflow: ellipsis;"><%= font.filename %></div>
              <div>
                <%= link_to 'Borrar', font_path(font.id), method: :delete, data: { confirm: '¿Estás seguro de borrar esta fuente?' }, class: 'text-decoration-none link-danger me-3' %>
                <%= link_to 'Descargar', rails_blob_path(font, disposition: 'attachment'), class: 'text-decoration-none link-primary' %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <br>

  <div class="card" data-controller="empty-state">
    <div class="card-header h5">Ideas fuerza</div>

    <div class="card-body"><%= render partial: 'ideas/form', locals: { order: @order, idea: @idea } %></div>

    <div data-empty-state-target="emptyState" class="card-body border-top visually-hidden">La orden no tiene ideas fuerza disponibles.</div>

    <ul id="ideas" class="list-group list-group-flush">
      <%= render partial: 'ideas/idea', collection: @order.ideas.filter(&:persisted?) %>
    </ul>
  </div>

  <br>

  <div class="card">
    <div class="card-header h5">Frases comerciales</div>

    <div class="card-body">
      <%= form_with model: [@order, @phrase], method: :post do |form| %>
        <% if @phrase.errors.any? %>
          <div class="alert alert-danger" role="alert">
            <h2><%= pluralize(@phrase.errors[:content].count, "error") %> evitaron guardar esta orden:</h2>
            <hr>
            <ul>
              <% @phrase.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-group">
          <%= form.text_field :content, class: 'form-control', required: true %>
          <div class="form-text">Frase corta que demuestra la competencia, característicicas, virtudes, fortalezas, objetivos o promociones que desean presentarse en el video. Esta frase se puede dividir a lo largo del video. Máximo 80 caracteres.</div>
        </div>

        <div>
          <%= form.submit 'Añadir frase comercial', class: 'btn btn-primary mt-2' %>
        </div>
      <% end %>
    </div>

    <% if @order.phrases.filter(&:persisted?).empty? %>
      <div class="card-body border-top">La orden no tiene frases comerciales disponibles.</div>
    <% else %>
      <ul class="list-group list-group-flush">
        <% @order.phrases.filter(&:persisted?).each do |phrase| %>
          <li class="list-group-item">
            <div class="d-flex flex-column flex-md-row justify-content-md-between">
              <div class="overflow-hidden" style="white-space: nowrap; text-overflow: ellipsis;"><%= phrase.content %></div>
              <div>
                <%= link_to 'Borrar', phrase, method: :delete, data: { confirm: '¿Estás seguro de borrar esta frase comercial?' }, class: 'text-decoration-none link-danger me-3' %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <br>

  <div class="card">
    <div class="card-header h5">Locuciones</div>

    <div class="card-body">
      <%= form_with url: order_locutions_path(@order.id), method: :post do |form| %>
        <% if @order.errors[:locutions].any? %>
          <div class="alert alert-danger" role="alert">
            <h2><%= pluralize(@order.errors.count, "error") %> evitaron guardar esta orden:</h2>
            <hr>
            <ul>
              <% @order.errors[:locutions].each do |error| %>
                <li><%= error %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-group">
          <%= form.file_field :locutions, class: 'form-control', required: true, accept: 'audio/mpeg' %>
          <div class="form-text">Cada locución debe estar en formato MP3.</div>
        </div>

        <div>
          <%= form.submit 'Añadir locución', class: 'btn btn-primary mt-2' %>
        </div>
      <% end %>
    </div>

    <% if @order.locutions.filter(&:persisted?).empty? %>
      <div class="card-body border-top">La orden no tiene locuciones disponibles.</div>
    <% else %>
      <div class="card-body border-top">
        <div class="row g-3">
          <% @order.locutions.filter(&:persisted?).each do |locution| %>
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
              <div>
                <audio controls style="max-width: 100%;">
                  <source src="<%= rails_blob_path locution %>">
                </audio>
                <div class="text-center"><strong><%= locution.filename %></strong></div>
                <div class="text-center text-secondary"><%= number_to_human_size locution.blob.byte_size %></div>
                <div class="text-center">
                  <%= link_to 'Borrar', locution_path(locution.id), method: :delete, data: { confirm: '¿Estás seguro de borrar esta locución?' }, class: 'text-decoration-none link-danger me-3' %>
                  <%= link_to 'Descargar', rails_blob_path(locution, disposition: 'attachment'), class: 'text-decoration-none link-primary' %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</main>

<%= render 'admin/footer' %>

<script>
    var grid = $('.grid').masonry()

    grid.imagesLoaded().progress(() => {
        grid.masonry('layout')
    })

    var observer = new MutationObserver((mutations, observer) => {
        grid.masonry('reloadItems')

        grid.masonry('layout')
    })

    var videos = document.getElementById('all_videos')

    observer.observe(videos, { childList: true, subtree: true })
</script>